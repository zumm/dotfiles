{{- /* chezmoi:modify-template */ -}}

{{- $currentProfiles := .chezmoi.stdin | fromIni -}}
{{- $modifiedProfiles := .chezmoi.stdin | fromIni -}}

{{- $profileName := "default-release" -}}

{{- $installPath := "C:\\Program Files\\Mozilla Firefox" -}}
{{- $installHash := mozillaInstallHash $installPath -}}
{{- $profilePath := printf "Profiles/%s" $profileName -}}

{{- /* Set default profile here */ -}}
{{- $_ := set $modifiedProfiles
  (printf "Install%s" $installHash) (dict
    "Default" $profilePath
    "Locked" 1
  )
-}}

{{- /* Remove existing profiles if present */ -}}
{{- range $section, $values := $modifiedProfiles -}}
{{-   if regexMatch "^Profile\\d+$" $section -}}
{{-     $_ := unset $modifiedProfiles $section -}}
{{-   end -}}
{{- end -}}

{{- /* Add profiles here */ -}}
{{- $_ := set $modifiedProfiles
  "Profile0" (dict
    "Name" $profileName
    "Path" $profilePath
    "IsRelative" 1
    "Default" 1
  )
-}}

{{- $_ := set $modifiedProfiles
  "General" (dict
    "StartWithLastProfile" 1
    "Version" 2
  )
-}}

{{- if deepEqual $currentProfiles $modifiedProfiles -}}
{{-   .chezmoi.stdin }}
{{- else -}}
{{-   includeTemplate "format/toMozillaIni" $modifiedProfiles | trim }}
{{- end }}
